#!/bin/bash

set -o errexit

CONFIG=
PASSWORD=
KEY_OPT=--auth-user-pass
while getopts "p:c:ak" opt; do
    case $opt in
        c) CONFIG=$OPTARG ;;
        p) PASSWORD=$OPTARG ;;
        a) KEY_OPT=--askpass ;;
        k) KEEP=1 ;;
        \?) echo "Invalid option: -$OPTARG" >&2
            exit 2 ;;
    esac
done

UP=$(mktemp up.XXXX)
chmod 0600 $UP
trap "{ rm -f $UP; }" EXIT

pass $PASSWORD > $UP
sudo -v
if [ -z "$KEEP" ]; then
    (sleep 4; ! fuser $UP; rm $UP ) &
fi
sudo --non-interactive openvpn --config $CONFIG --auth-nocache $KEY_OPT $UP
