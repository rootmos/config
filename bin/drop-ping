#!/bin/bash

set -o pipefail

TARGET=ip.rootmos.io

icmp() {
    ping -q -n -c3 -i0.2 $TARGET \
        | grep avg \
        | cut -f4 -d' ' | cut -f2 -d'/'
}

ssl() {
    ulimit -c 0
    timeout 1 httping -G -M -c1 -f https://$TARGET \
        | jq .[0].total_ms -r \
        | xargs -I{} calc -p "round({})"
}

MS=$(icmp)
if [ $? -eq 0 ]; then
    printf "%.0fms" "$MS"
else
    echo -n "-"
fi

echo -n " "

MS=$(ssl)
if [ $? -eq 0 ]; then
    echo -n "${MS}ms"
else
    echo -n "-"
fi

CITY=$(curl --max-time 1 https://ip.rootmos.io/city)
if [ $? -eq 0 -a -n "$CITY" ]; then
    echo -n " $CITY"
else
    echo -n "-"
fi
