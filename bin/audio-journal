#!/bin/bash

set -o nounset -o pipefail -o errexit

TMP=$(mktemp -d)
trap "rm -rf $TMP" EXIT

ACTION=record
MODE=release
TITLE=
while getopts "pRrlPm:t:" OPT; do
    case $OPT in
        r) ACTION=record ;;
        l) ACTION=list ;;
        P) ACTION=publish ;;
        p) MODE=practice ;;
        R) MODE=release ;;
        m) MODE=$OPTARG ;;
        t) TITLE=$OPTARG ;;
        \?) echo "Invalid option: -$OPTARG" >&2; exit 2 ;;
    esac
done
shift $((OPTIND-1))

. $(readlink -f $0 | xargs dirname)/audio-journal.lib.sh

record() {
    clear
    read -n1 -s -p "Ready? ($MODE) "

    DATE=$(date -Is)
    case "$MODE" in
        release)
            RAW=$TAKES/$DATE.raw.flac
            PRE=$TMP/$DATE.pre.flac
            ;;
        practice)
            RAW=$TMP/$DATE.raw.flac
            PRE=$TMP/$DATE.pre.flac
            ;;
        *) echo "Unsupported mode: $MODE" >&2; exit 2;;
    esac

    clear
    take "$RAW" &
    PID=$!
    IFS= read -n1 -s TAKE_CHOICE

    kill -INT $PID
    wait $PID

    if [ "$MODE" = "release" -a -z "$TAKE_CHOICE" ]; then
        clear
        preprocess "$RAW" "$PRE"
        playback "$PRE"
        read -p "Yay or nay? " POST_CHOICE
    fi

    case "${POST_CHOICE-y}" in
        y|Y) postprocess "$RAW" "$DATE" "$TITLE";;
    esac
}

if [ "$ACTION" = "record" ]; then
    while true; do record; done
elif [ "$ACTION" = "list" ]; then
    list | mpv --playlist=-
elif [ "$ACTION" = "publish" ]; then
    publish "$1" "$TITLE"
fi
