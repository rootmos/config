#!/bin/bash

set -o nounset -o pipefail -o errexit

TMP=$(mktemp -d)
trap 'rm -rf $TMP' EXIT

ACTION=record
MODE=release
TITLE=
PRE_FILTERS="norm"
POST_FILTERS="norm"
AUDIO_JOURNAL=${AUDIO_JOURNAL-$HOME/audio-journal}
SUFFIX=${AUDIO_JOURNAL_SUFFIX-.mp3}
PLAYER=${PLAYER-mpv}
BUCKET=${AUDIO_JOURNAL_BUCKET-rootmos-sounds}
while getopts "pRrlLPm:t:" OPT; do
    case $OPT in
        r) ACTION=record ;;
        l) ACTION=listen ;;
        L) ACTION=list ;;
        P) ACTION=publish ;;
        p) MODE=practice ;;
        R) MODE=release ;;
        m) MODE=$OPTARG ;;
        t) TITLE=$OPTARG ;;
        \?) echo "Invalid option: -$OPTARG" >&2; exit 2 ;;
    esac
done
shift $((OPTIND-1))

# functions

take() {
    rec "$1"
}

preprocess() {
    sox "$1" "$2" $PRE_FILTERS
}

save_to_secondary() {
    if [[ -v AUDIO_JOURNAL_SECONDARY ]]; then
        IFS=':' read -ra SECONDARY <<< "$AUDIO_JOURNAL_SECONDARY"
        for target in "${SECONDARY[@]}"; do
            if [ -d "$target" ]; then
                rsync -ha --progress "$1" "$target"
            fi
        done
    fi
}

upload() {
    s3cmd put --acl-public "$1" "s3://$BUCKET/$PREFIX"
}

url() {
    echo "https://$BUCKET.ams3.cdn.digitaloceanspaces.com/$PREFIX$1"
}

tag() {
    DATE=$2
    TITLE=$3
    YEAR=$(date --date="$DATE" +%Y)
    LENGTH=$(soxi -D "$1")
    FILENAME=$(basename "$1")
    URL=$(url "$FILENAME")
    id3v2 1>&2 -D "$1"
    id3v2 1>&2 \
        --artist=rootmos \
        --song="$TITLE" \
        --TCOM="Gustav Behm" \
        --TCOP="$YEAR Gustav Behm" \
        --WOAR="https://rootmos.io" \
        --WOAF="$URL" \
        --TRDA="$DATE" \
        --TLEN="$LENGTH" \
        --year="$YEAR" \
        --genre=52 \
        "$1"

    METADATA=$(basename --suffix="$SUFFIX" "$1").json
    cat > "$METADATA" <<EOF
{
    "title": "$TITLE",
    "sha1": "$(sha1sum "$1" | cut -d' ' -f1)",
    "url": "$URL",
    "filename": "$FILENAME",
    "artist": "rootmos",
    "composer": "Gustav Behm",
    "date": "$DATE",
    "year": $YEAR,
    "length": $LENGTH
}
EOF

    echo "$METADATA"
}

postprocess() {
    DATE=$2
    TITLE=$3
    unset OUT
    if [ "$MODE" = "release" ]; then
        if [ -z "$TITLE" ]; then
            read -rp "Title: " TITLE
        fi

        if [ -n "$TITLE" ]; then
            OUT=$AUDIO_JOURNAL/${DATE}_$(tr ' ' '-' <<< "$TITLE")$SUFFIX
        fi
    fi

    if [[ ! -v OUT ]]; then
        mkdir -p "$AUDIO_JOURNAL/$MODE"
        OUT=$AUDIO_JOURNAL/$MODE/$DATE$SUFFIX
        TITLE="Session @ $DATE"
    fi

    sox --ignore-length "$1" "$OUT" $POST_FILTERS
    METADATA=$(tag "$OUT" "$DATE" "$TITLE")
    if [[ ! -v DRY_RUN ]]; then
        save_to_secondary "$OUT"
        save_to_secondary "$METADATA"
        upload "$OUT"
        upload "$METADATA"
    fi
}

get_tag() {
    id3v2 --list "$2" | grep "^$1" | sed 's/^'"$1"'[^:]*: \(.*\)$/\1/'
}

publish() {
    TITLE=$2
    if [ -z "$TITLE" ]; then
        TITLE=$(get_tag TIT2 "$1")
    fi

    DATE=$(get_tag TRDA "$1")
    if [ -z "$DATE" ]; then
        DATE=$(date -Is)
    fi

    POST_FILTERS='' postprocess "$1" "$DATE" "$TITLE"
}

playback() {
    $PLAYER "$1"
}

list() {
    export -f url
    s3cmd ls -l "s3://$BUCKET/$PREFIX" \
        | awk '{ print $6 }' \
        | grep "$SUFFIX$" \
        | sort -r | while read -r f; do
        url "$(basename "$f")"
    done
}

choose_takes_dir() {
    IFS=':' read -ra TAKES <<< "${AUDIO_JOURNAL_TAKES-}"
    for target in "${TAKES[@]}"; do
        if [ -d "$target" ]; then
            echo "$target"
            return
        fi
    done
    echo "$AUDIO_JOURNAL/takes"
}

record() {
    clear
    read -rsn1 -p "Ready? ($MODE) "

    TAKES_DIR=$(choose_takes_dir)
    mkdir -p "$TAKES_DIR"

    DATE=$(date -Is)
    case "$MODE" in
        release)
            RAW=$TAKES_DIR/$DATE.raw.flac
            PRE=$TMP/$DATE.pre.flac
            ;;
        practice)
            RAW=$TMP/$DATE.raw.flac
            PRE=$TMP/$DATE.pre.flac
            ;;
        *) echo "Unsupported mode: $MODE" >&2; exit 2;;
    esac

    clear
    take "$RAW" &
    PID=$!
    IFS= read -rsfn1 TAKE_CHOICE

    kill -INT $PID
    wait $PID

    if [ "$MODE" = "release" ] && [ -z "$TAKE_CHOICE" ]; then
        clear
        preprocess "$RAW" "$PRE"
        playback "$PRE"
        read -rp "Yay or nay? " POST_CHOICE
    fi

    case "${POST_CHOICE-y}" in
        y|Y) postprocess "$RAW" "$DATE" "$TITLE";;
    esac
}

require() {
    OK=true
    for x in "$@"; do
        if ! command -v "$x" > /dev/null; then
            echo "please install $x" 1>&2
            OK=false
        fi
    done

    $OK || exit 1
}

# run

case "$MODE" in
    release) PREFIX= ;;
    *) PREFIX=$MODE/ ;;
esac

prepare() {
    require s3cmd sox id3v2 rsync
    mkdir -p "$AUDIO_JOURNAL"
}

prepare_read_only() {
    require s3cmd
}

case $ACTION in
    record)
        prepare
        while true; do record; done
        ;;
    publish)
        prepare
        publish "$1" "$TITLE"
        ;;
    list)
        prepare_read_only
        list
        ;;
    listen)
        prepare_read_only
        list | $PLAYER --playlist=-
        ;;
    *) exit 1;;
esac
