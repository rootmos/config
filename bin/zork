#!/bin/bash

set -o nounset -o pipefail -o errexit

GARGOYLE_ROOT=$(readlink -f "$(which gargoyle | xargs dirname)/..")
INTERPRETERS=$GARGOYLE_ROOT/libexec/gargoyle

GAME=$(readlink -f "$1")
GAMEID=$(sha256sum "$GAME" | cut -d' ' -f1)

PLAYTHROUGH_ROOT=${PLAYTHROUGH_ROOT-$HOME/games/if/.playthrough}
PLAYTHROUGH=${PLAYTHROUGH-$PLAYTHROUGH_ROOT/$GAMEID}
mkdir -p "$PLAYTHROUGH"

NOW=$(date -Is)
CMDS=$PLAYTHROUGH/$NOW.cmds.txt
TRANSCRIPT=$PLAYTHROUGH/$NOW.transcript.txt

ln -fs "$GAME" "$PLAYTHROUGH/$(basename "$GAME")"

TYPE=$(file --brief --mime-type "$GAME")
SUFFIX=$(sed 's/.*\.\([a-zA-Z0-9\$]\+\)$/\1/' <<< "$GAME")

export GAMES=$PLAYTHROUGH
if [ "$TYPE" = "application/x-zmachine" ] || [ "$SUFFIX" = "zblorb" ]; then
    "$INTERPRETERS/bocfel" \
        -s -S "$CMDS" -t -T "$TRANSCRIPT" \
        "$GAME"
elif [ "$TYPE" = "application/x-tads" ] || [ "$SUFFIX" = "t3" ]; then
    "$INTERPRETERS/tadsr" \
        -o "$CMDS" -l "$TRANSCRIPT" \
        "$GAME"
elif [ "$SUFFIX" = "gblorb" ]; then
    "$INTERPRETERS/git" "$GAME"
elif [ "$SUFFIX" = "taf" ]; then
    "$INTERPRETERS/scare" "$GAME"
elif [ "$SUFFIX" = "d\$\$" ] || [ "$SUFFIX" = "D\$\$" ]; then
    "$INTERPRETERS/agility" "$GAME"
fi
