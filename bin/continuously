#!/bin/bash

TARGET=.
WRAPPER=$(pwd)/.k
while getopts "t:w:" OPT; do
    case $OPT in
        t) TARGET=$OPTARG ;;
        w) WRAPPER=$OPTARG ;;
        \?) echo "Invalid option: -$OPTARG" >&2; exit 2 ;;
    esac
done
shift $((OPTIND-1))

manual_waiter() {
  read -sp "[wait] " < /dev/tty && echo 1>&2 "[manual trigger]"
}

file_waiter() {
  inotifywait --quiet -e close_write,moved_to --format="%f" \
    $(git ls-files "$1" 2>/dev/null || echo "$1")
  echo 1>&2 "[file trigger]"
}

go() {
    if [ -f "$WRAPPER" ]; then
        /bin/sh $WRAPPER $*
    else
        $*
    fi
}

while true; do
  manual_waiter &
  manual_pid=$!
  file_waiter "$TARGET" &
  file_pid=$!

  trap "kill $manual_pid $file_pid; echo; exit 0" INT
  wait -n $manual_pid $file_pid
  kill $manual_pid $file_pid 2>/dev/null
  wait
  trap - INT

  (go $*) &
  child_pid=$!
  trap "killall -q $child_pid; echo" INT
  wait $child_pid
  wait
  trap - INT
done
